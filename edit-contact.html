<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contact Book - Edit Contact</title>

    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #863c3c; padding: 8px; text-align: left; }
        tr:hover { background-color: #ca8ccf; cursor: pointer; }
        form { margin: 20px 0; }
        label { display: inline-block; width: 100px; }
        input { margin-bottom: 10px; }
    </style>
</head>
<body onload="getContact()">
    <div id="avatarImage"></div>
    <form id="editForm">
    <label for="firstname">First Name</label>
    <input type="text" name="firstname" id="firstname" autocomplete="given-name"><br/>

    <label for="lastname">Last Name</label>
    <input type="text" name="lastname" id="lastname" autocomplete="family-name"><br/>

    <label for="mobile">Mobile</label>
    <input type="text" name="mobile" id="mobile" autocomplete="tel"><br/>

    <label for="email">Email</label>
    <input type="text" name="email" id="email" autocomplete="email"><br/>

    <label for="avatar">Select a file</label><br/>
    <input type="file" name="avatar" id="avatar"><br/>

    <button type="submit" id="submitForm">Submit</button>
</form>

    <br/><br/>
    <button id="homeLink" type="button">Home</button>
    <button id="editContact" type="button">Edit</button>
    <button id="deleteContact" type="button">Delete</button>

    <script src="config.js"></script>
    <script>
        var id = getID();
        console.log("The id is :" + id);
        document.getElementById("homeLink").addEventListener('click', homeLink);
        document.getElementById("editContact").addEventListener('click', editContact);
        document.getElementById("submitForm").addEventListener('click', submitForm);
        document.getElementById("deleteContact").addEventListener('click', deleteContact);

        function getID(){
            var url = window.location.href;
            var pos = url.search("=");
            var id = url.slice(pos +1);
            return id;
        }


        function getContact(){
            fetch(rootPath + 'controller/get-contacts/?id=' + id)
            .then(function(response){
                return response.json();
            })
            .then(function(data){
                displayOutput(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Failed to load contact. Please try again.");
            });
        }


        function homeLink(){
            window.open("index.html", "_self");
        }


        function displayOutput(data){
            avatarImg = ` 
                <img src="${rootPath}/controller/uploads/${data[0].avatar}" width="200"/>`;
            document.getElementById("avatarImage").innerHTML = avatarImg;
            document.getElementById('firstname').value = data[0].firstname;
            document.getElementById('lastname').value = data[0].lastname;
            document.getElementById('mobile').value = data[0].mobile;
            document.getElementById('email').value = data[0].email;
        }

        function submitForm(e){
            e.preventDefault(); //prevents the form from reloading the page
            const form = new FormData(document.querySelector("#editForm"));
            form.append('apiKey', apiKey);
            form.append('id', id);
            
            fetch(rootPath + 'controller/edit-contact/', {
                method: 'POST',
                headers: {'Accept': 'application/json, *.*'},
                body: form
            })
            .then(function(response){
                return response.text();
            })
            .then(function(data){
                if(data == "1"){
                    alert("Contact edited");
                    homeLink();
                }else{
                    alert(data);
                    homeLink();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Failed to edit contact. Please try again.");
            });
        }

        function deleteContact(){
            var confirmDelete = confirm("Delete contact. Are you sure?");

            if(confirmDelete){
                fetch(rootPath + 'controller/delete-contact/?id=' + id)
                .then(function(response){
                    return response.text();
                })
                .then(function(data){
                    if(data == "1"){
                        homeLink();
                    }else{
                        alert(data);
                    }
                })
            }
        }
    </script>
</body>
</html>